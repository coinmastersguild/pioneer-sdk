# Dashboard Cache Validation Fix
# This patch adds validation to reject corrupted cache data and use correct slow path

# Problem: Fast path (line 380-399) uses corrupted cache with 3,236 empty network objects
# Solution: Validate cache data and use slow path when corrupted

--- a/packages/pioneer/pioneer-sdk/src/index.ts
+++ b/packages/pioneer/pioneer-sdk/src/index.ts
@@ -377,8 +377,32 @@
           }
 
-          // Create dashboard data
-          const dashboardData = {
+          // Validate cache data before using it
+          const isCacheDataValid = (portfolioData: any): boolean => {
+            // Check if networks data is reasonable (should be < 50 networks, not thousands)
+            if (!portfolioData.networks || !Array.isArray(portfolioData.networks)) {
+              console.warn('[CACHE VALIDATION] Networks is not an array');
+              return false;
+            }
+            
+            if (portfolioData.networks.length > 50) {
+              console.error(`[CACHE VALIDATION] CORRUPTED: ${portfolioData.networks.length} networks (should be < 50)`);
+              return false;
+            }
+            
+            // Check if at least some networks have required fields
+            const validNetworks = portfolioData.networks.filter((n: any) => 
+              n.networkId && n.totalValueUsd !== undefined && n.gasAssetSymbol
+            );
+            
+            if (validNetworks.length === 0 && portfolioData.networks.length > 0) {
+              console.error('[CACHE VALIDATION] CORRUPTED: No networks have required fields');
+              return false;
+            }
+            
+            return true;
+          };
+
+          // Only use cache data if it's valid
+          if (isCacheDataValid(portfolioData)) {
+            console.log('[CACHE VALIDATION] ✅ Cache data is valid, using fast path');
+            const dashboardData = {
+              totalValueUsd: portfolioData.totalValueUsd,
+              pairedDevices: portfolioData.pairedDevices,
+              devices: portfolioData.devices || [],
+              networks: portfolioData.networks || [],
+              assets: portfolioData.assets || [],
+              statistics: portfolioData.statistics || {},
+              cached: portfolioData.cached,
+              lastUpdated: portfolioData.lastUpdated,
+              cacheAge: portfolioData.lastUpdated
+                ? Math.floor((Date.now() - portfolioData.lastUpdated) / 1000)
+                : 0,
+              networkPercentages:
+                portfolioData.networks?.map((network: any) => ({
+                  networkId: network.network_id || network.networkId,
+                  percentage: network.percentage || 0,
+                })) || [],
+            };
+            
+            this.dashboard = dashboardData;
+            this.events.emit('SET_DASHBOARD', this.dashboard);
+          } else {
+            console.warn('[CACHE VALIDATION] ❌ Cache data corrupted, will use slow path dashboard building');
+            // Don't set dashboard here - let sync() build it correctly
+          }
+
-            totalValueUsd: portfolioData.totalValueUsd,
-            pairedDevices: portfolioData.pairedDevices,
-            devices: portfolioData.devices || [],
-            networks: portfolioData.networks || [],
-            assets: portfolioData.assets || [],
-            statistics: portfolioData.statistics || {},
-            cached: portfolioData.cached,
-            lastUpdated: portfolioData.lastUpdated,
-            cacheAge: portfolioData.lastUpdated
-              ? Math.floor((Date.now() - portfolioData.lastUpdated) / 1000)
-              : 0,
-            networkPercentages:
-              portfolioData.networks?.map((network: any) => ({
-                networkId: network.network_id || network.networkId,
-                percentage: network.percentage || 0,
-              })) || [],
-          };
-
-          this.dashboard = dashboardData;
-          this.events.emit('SET_DASHBOARD', this.dashboard);
